name: Deploy Hugo Blog to Multiple Platforms

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # 支持手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. 检出代码
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    # 2. 安装Hugo
    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: 'latest'
        extended: true

    # 3. 构建网站
    - name: Build Hugo Site
      run: hugo --minify

    # 4. 部署到七牛云
    - name: Deploy to Qiniu Cloud
      env:
        QINIU_ACCESS_KEY: ${{ secrets.QINIU_ACCESS_KEY }}
        QINIU_SECRET_KEY: ${{ secrets.QINIU_SECRET_KEY }}
        QINIU_BUCKET: ${{ secrets.QINIU_BUCKET }}
        QINIU_ZONE: ${{ secrets.QINIU_ZONE }}
      run: |
        # 检查是否配置了七牛云密钥
        if [ -z "$QINIU_ACCESS_KEY" ]; then
          echo "⚠️ 七牛云密钥未配置，跳过七牛云部署"
          exit 0
        fi
        
        # 安装七牛云命令行工具
        npm install -g qshell
        
        # 配置七牛云账号
        qshell account $QINIU_ACCESS_KEY $QINIU_SECRET_KEY
        
        # 创建上传配置文件
        cat > qiniu_upload.json << EOF
        {
          "src_dir": "public",
          "bucket": "$QINIU_BUCKET",
          "key_prefix": "",
          "overwrite": true,
          "check_exists": true,
          "check_hash": true,
          "check_size": true,
          "rescan_local": true
        }
        EOF
        
        # 上传文件到七牛云
        qshell qupload qiniu_upload.json
        
        echo "✅ 部署到七牛云完成！"

    # 5. 备用：同时部署到GitHub Pages
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
        cname: www.cavai.cn
