name: Deploy Hugo Blog to Multiple Platforms

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    # 2. å®‰è£…Hugo
    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: 'latest'
        extended: true

    # 3. æž„å»ºç½‘ç«™
    - name: Build Hugo Site
      run: hugo --minify

    # 4. éƒ¨ç½²åˆ°ä¸ƒç‰›äº‘
    - name: Deploy to Qiniu Cloud
      env:
        QINIU_ACCESS_KEY: ${{ secrets.QINIU_ACCESS_KEY }}
        QINIU_SECRET_KEY: ${{ secrets.QINIU_SECRET_KEY }}
        QINIU_BUCKET: ${{ secrets.QINIU_BUCKET }}
        QINIU_ZONE: ${{ secrets.QINIU_ZONE }}
      run: |
        # æ£€æŸ¥æ˜¯å¦é…ç½®äº†ä¸ƒç‰›äº‘å¯†é’¥
        if [ -z "$QINIU_ACCESS_KEY" ]; then
          echo "âš ï¸ ä¸ƒç‰›äº‘å¯†é’¥æœªé…ç½®ï¼Œè·³è¿‡ä¸ƒç‰›äº‘éƒ¨ç½²"
          exit 0
        fi
        
        echo "ðŸ”§ å¼€å§‹é…ç½®ä¸ƒç‰›äº‘éƒ¨ç½²..."
        echo "ðŸ“¦ å­˜å‚¨æ¡¶: $QINIU_BUCKET"
        echo "ðŸŒ å­˜å‚¨åŒºåŸŸ: $QINIU_ZONE"
        
        # æ£€æŸ¥publicç›®å½•å†…å®¹
        echo "ðŸ“ æ£€æŸ¥æž„å»ºäº§ç‰©:"
        ls -la public/
        echo "ðŸ“„ æ£€æŸ¥index.htmlæ˜¯å¦å­˜åœ¨:"
        if [ -f "public/index.html" ]; then
          echo "âœ… index.html å­˜åœ¨"
          head -5 public/index.html
        else
          echo "âŒ index.html ä¸å­˜åœ¨!"
          exit 1
        fi
        
        # å®‰è£…ä¸ƒç‰›äº‘å‘½ä»¤è¡Œå·¥å…·
        echo "ðŸ› ï¸ å®‰è£…qshellå·¥å…·..."
        npm install -g qshell
        
        # é…ç½®ä¸ƒç‰›äº‘è´¦å·
        echo "ðŸ”‘ é…ç½®ä¸ƒç‰›äº‘è´¦å·..."
        qshell account $QINIU_ACCESS_KEY $QINIU_SECRET_KEY qiniu-deploy
        
        # åˆ›å»ºä¸Šä¼ é…ç½®æ–‡ä»¶
        echo "ðŸ“‹ åˆ›å»ºä¸Šä¼ é…ç½®..."
        cat > qiniu_upload.json << EOF
        {
          "src_dir": "public",
          "bucket": "$QINIU_BUCKET",
          "key_prefix": "",
          "overwrite": true,
          "check_exists": true,
          "check_hash": true,
          "check_size": true,
          "rescan_local": true
        }
        EOF
        
        echo "ðŸ“¤ å¼€å§‹ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘..."
        # ä¸Šä¼ æ–‡ä»¶åˆ°ä¸ƒç‰›äº‘
        qshell qupload qiniu_upload.json
        
        # æ£€æŸ¥ä¸Šä¼ ç»“æžœ
        echo "ðŸ” æ£€æŸ¥ä¸Šä¼ ç»“æžœ..."
        qshell listbucket $QINIU_BUCKET --prefix="" --max=10
        
        echo "âœ… éƒ¨ç½²åˆ°ä¸ƒç‰›äº‘å®Œæˆï¼"
        echo "ðŸŒ è®¿é—®åœ°å€: http://$QINIU_BUCKET.your-domain.com"
