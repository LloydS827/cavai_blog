name: Deploy Hugo Blog to Multiple Platforms

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # 支持手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. 检出代码
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    # 2. 安装Hugo
    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: 'latest'
        extended: true

    # 3. 构建网站
    - name: Build Hugo Site
      run: hugo --minify

    # 4. 部署到七牛云
    - name: Deploy to Qiniu Cloud
      env:
        QINIU_ACCESS_KEY: ${{ secrets.QINIU_ACCESS_KEY }}
        QINIU_SECRET_KEY: ${{ secrets.QINIU_SECRET_KEY }}
        QINIU_BUCKET: ${{ secrets.QINIU_BUCKET }}
        QINIU_ZONE: ${{ secrets.QINIU_ZONE }}
      run: |
        # 检查是否配置了七牛云密钥
        if [ -z "$QINIU_ACCESS_KEY" ]; then
          echo "⚠️ 七牛云密钥未配置，跳过七牛云部署"
          exit 0
        fi
        
        echo "🔧 开始配置七牛云部署..."
        echo "📦 存储桶: $QINIU_BUCKET"
        echo "🌍 存储区域: $QINIU_ZONE"
        
        # 检查public目录内容
        echo "📁 检查构建产物:"
        ls -la public/
        echo "📄 检查index.html是否存在:"
        if [ -f "public/index.html" ]; then
          echo "✅ index.html 存在"
          head -5 public/index.html
        else
          echo "❌ index.html 不存在!"
          exit 1
        fi
        
        # 安装七牛云命令行工具
        echo "🛠️ 安装qshell工具..."
        npm install -g qshell
        
        # 配置七牛云账号
        echo "🔑 配置七牛云账号..."
        qshell account $QINIU_ACCESS_KEY $QINIU_SECRET_KEY qiniu-deploy
        
        # 创建上传配置文件
        echo "📋 创建上传配置..."
        cat > qiniu_upload.json << EOF
        {
          "src_dir": "public",
          "bucket": "$QINIU_BUCKET",
          "key_prefix": "",
          "overwrite": true,
          "check_exists": true,
          "check_hash": true,
          "check_size": true,
          "rescan_local": true
        }
        EOF
        
        echo "📤 开始上传到七牛云..."
        # 上传文件到七牛云
        qshell qupload qiniu_upload.json
        
        # 检查上传结果
        echo "🔍 检查上传结果..."
        qshell listbucket $QINIU_BUCKET --prefix="" --max=10
        
        echo "✅ 部署到七牛云完成！"
        echo "🌐 访问地址: http://$QINIU_BUCKET.your-domain.com"
